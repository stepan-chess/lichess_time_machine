<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title data-i18n="app_title">Lichess Time Machine</title>
    <style>
        /* --- ЦВЕТОВЫЕ ПЕРЕМЕННЫЕ --- */
        :root {
            /* 1. Monochrome (Original) */
            --bg-body: #f0f0f0; --text-main: #111; --bg-container: #fff; --border-main: #000;
            --shadow: rgba(0,0,0,0.2); --input-bg: #fafafa; --input-border: #ccc;
            --btn-bg: #000; --btn-text: #fff; --btn-hover-bg: #fff; --btn-hover-text: #000;
            --item-hover: #f9f9f9; --win-border: #000; --loss-border: #ccc; --draw-border: #eee;
            --win-text: #000; --loss-text: #999; --draw-text: #777;
            --online-color: #28a745; --offline-color: #6c757d;
        }

        /* 2. Terminal Green (Dark Black + Calm Green) - ЦВЕТ ИЗМЕНЕН */
        [data-theme="dark-green"] {
            --bg-body: #050505; 
            --text-main: #00c000; /* Более темный, спокойный зеленый */
            --bg-container: #000000; 
            --border-main: #008800; /* Темно-зеленая рамка */
            --shadow: rgba(0, 150, 0, 0.1); 
            --input-bg: #0a0a0a; 
            --input-border: #004400;
            --btn-bg: #003300; 
            --btn-text: #00c000; 
            --btn-hover-bg: #00c000; 
            --btn-hover-text: #000000;
            --item-hover: #0f0f0f; 
            --win-border: #00c000; 
            --loss-border: #550000; 
            --draw-border: #004400;
            --win-text: #00c000; 
            --loss-text: #aa4444; 
            --draw-text: #006600;
            --online-color: #00c000; 
            --offline-color: #333;
        }

        /* Остальные темы */
        [data-theme="midnight"] { --bg-body: #0f172a; --text-main: #e2e8f0; --bg-container: #1e293b; --border-main: #3b82f6; --shadow: rgba(0,0,0,0.5); --input-bg: #334155; --input-border: #475569; --btn-bg: #3b82f6; --btn-text: #fff; --btn-hover-bg: #60a5fa; --btn-hover-text: #000; --item-hover: #334155; --win-border: #3b82f6; --loss-border: #ef4444; --draw-border: #94a3b8; --win-text: #60a5fa; --loss-text: #f87171; --draw-text: #cbd5e1; }
        [data-theme="forest"] { --bg-body: #1a2f1a; --text-main: #d1e7dd; --bg-container: #263e26; --border-main: #4caf50; --shadow: rgba(0,0,0,0.5); --input-bg: #355235; --input-border: #557a55; --btn-bg: #4caf50; --btn-text: #fff; --btn-hover-bg: #81c784; --btn-hover-text: #000; --item-hover: #2f4f2f; --win-border: #66bb6a; --loss-border: #a5d6a7; --draw-border: #81c784; --win-text: #a5d6a7; --loss-text: #557a55; --draw-text: #81c784; }
        [data-theme="sepia"] { --bg-body: #f4ecd8; --text-main: #5b4636; --bg-container: #fffbf0; --border-main: #8d6e63; --shadow: rgba(91, 70, 54, 0.2); --input-bg: #fdf5e6; --input-border: #d7ccc8; --btn-bg: #5d4037; --btn-text: #fff; --btn-hover-bg: #8d6e63; --btn-hover-text: #fff; --item-hover: #fff3e0; --win-border: #5d4037; --loss-border: #bcaaa4; --draw-border: #a1887f; --win-text: #3e2723; --loss-text: #8d6e63; --draw-text: #6d4c41; }
        [data-theme="cyberpunk"] { --bg-body: #050505; --text-main: #0ff; --bg-container: #111; --border-main: #f0f; --shadow: rgba(255, 0, 255, 0.4); --input-bg: #222; --input-border: #0ff; --btn-bg: #f0f; --btn-text: #000; --btn-hover-bg: #0ff; --btn-hover-text: #000; --item-hover: #1a1a1a; --win-border: #0f0; --loss-border: #f00; --draw-border: #ff0; --win-text: #0f0; --loss-text: #f00; --draw-text: #ff0; }
        [data-theme="ocean"] { --bg-body: #e0f7fa; --text-main: #006064; --bg-container: #fff; --border-main: #00bcd4; --shadow: rgba(0, 188, 212, 0.2); --input-bg: #e0f2f1; --input-border: #4dd0e1; --btn-bg: #00bcd4; --btn-text: #fff; --btn-hover-bg: #0097a7; --btn-hover-text: #fff; --item-hover: #e1f5fe; --win-border: #00acc1; --loss-border: #b2ebf2; --draw-border: #80deea; --win-text: #006064; --loss-text: #4dd0e1; --draw-text: #0097a7; }
        [data-theme="dracula"] { --bg-body: #282a36; --text-main: #f8f8f2; --bg-container: #44475a; --border-main: #bd93f9; --shadow: rgba(0,0,0,0.5); --input-bg: #6272a4; --input-border: #bd93f9; --btn-bg: #ff79c6; --btn-text: #282a36; --btn-hover-bg: #bd93f9; --btn-hover-text: #fff; --item-hover: #282a36; --win-border: #50fa7b; --loss-border: #ff5555; --draw-border: #f1fa8c; --win-text: #50fa7b; --loss-text: #ff5555; --draw-text: #f1fa8c; }
        [data-theme="crimson"] { --bg-body: #2b0a0a; --text-main: #ffd1d1; --bg-container: #4a1212; --border-main: #ff4d4d; --shadow: rgba(255, 0, 0, 0.2); --input-bg: #661a1a; --input-border: #ff8080; --btn-bg: #ff0000; --btn-text: #fff; --btn-hover-bg: #ff6666; --btn-hover-text: #000; --item-hover: #5c1818; --win-border: #ffcccc; --loss-border: #cc0000; --draw-border: #ff6666; --win-text: #fff; --loss-text: #ff9999; --draw-text: #ffb3b3; }
        [data-theme="solar-light"] { --bg-body: #fdf6e3; --text-main: #657b83; --bg-container: #eee8d5; --border-main: #b58900; --shadow: rgba(0,0,0,0.1); --input-bg: #fff; --input-border: #93a1a1; --btn-bg: #b58900; --btn-text: #fff; --btn-hover-bg: #cb4b16; --btn-hover-text: #fff; --item-hover: #fdf6e3; --win-border: #859900; --loss-border: #dc322f; --draw-border: #2aa198; --win-text: #859900; --loss-text: #dc322f; --draw-text: #2aa198; }
        [data-theme="high-contrast"] { --bg-body: #fff; --text-main: #000; --bg-container: #fff; --border-main: #000; --shadow: none; --input-bg: #fff; --input-border: #000; --btn-bg: #000; --btn-text: #fff; --btn-hover-bg: #fff; --btn-hover-text: #000; --item-hover: #fff; --win-border: #000; --loss-border: #000; --draw-border: #000; --win-text: #000; --loss-text: #000; --draw-text: #000; }
        [data-theme="royal"] { --bg-body: #240046; --text-main: #e0aaff; --bg-container: #3c096c; --border-main: #9d4edd; --shadow: rgba(0,0,0,0.5); --input-bg: #5a189a; --input-border: #7b2cbf; --btn-bg: #e0aaff; --btn-text: #240046; --btn-hover-bg: #c77dff; --btn-hover-text: #000; --item-hover: #240046; --win-border: #e0aaff; --loss-border: #5a189a; --draw-border: #9d4edd; --win-text: #e0aaff; --loss-text: #9d4edd; --draw-text: #c77dff; }

        /* --- ГЛОБАЛЬНЫЕ СТИЛИ --- */
        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-size: 19px; 
            line-height: 1.5;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background-color: var(--bg-container); 
            padding: 40px; 
            border: 2px solid var(--border-main); 
            box-shadow: 10px 10px 0px var(--shadow);
            transition: all 0.3s;
        }

        /* --- НОВАЯ ШАПКА: FLEX LAYOUT --- */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Центрирование по вертикали */
            border-bottom: 4px solid var(--border-main);
            padding-bottom: 15px;
            margin-bottom: 15px; /* Уменьшен margin-bottom, чтобы текст был ближе */
            gap: 20px;
            flex-wrap: wrap; /* Для адаптивности */
        }

        .header-row h1 {
            margin: 0; /* Убираем отступы, чтобы стояло ровно */
            padding: 0;
            border: none;
            font-size: 2.2em;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -0.5px;
            color: var(--text-main);
            line-height: 1;
        }

        .theme-lang-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-lang-controls select, .theme-lang-controls button {
            padding: 10px 15px;
            font-size: 1em;
            background: var(--input-bg);
            color: var(--text-main);
            border: 2px solid var(--border-main);
            cursor: pointer;
            font-weight: bold;
            outline: none;
            min-width: 100px;
            transition: all 0.2s;
        }
        .theme-lang-controls select {
            min-width: 150px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2C114.7L154.5%2C19.8c-4.2-4.1-11-4.1-15.2%2C0L5.4%2C114.7c-4.1%2C4.1-4.1%2C10.8%2C0%2C15l7.6%2C7.6c4.1%2C4.1%2C10.8%2C4.1%2C15%2C0l118.8-118.8l118.8%2C118.8c4.1%2C4.1%2C10.8%2C4.1%2C15%2C0l7.6-7.6C291.1%2C125.5%2C291.1%2C118.9%2C287%2C114.7z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 12px;
        }
        /* Стрелка для темных тем */
        [data-theme="dark-green"] select, [data-theme="midnight"] select, [data-theme="cyberpunk"] select, [data-theme="dracula"] select, [data-theme="crimson"] select, [data-theme="royal"] select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23cccccc%22%20d%3D%22M287%2C114.7L154.5%2C19.8c-4.2-4.1-11-4.1-15.2%2C0L5.4%2C114.7c-4.1%2C4.1-4.1%2C10.8%2C0%2C15l7.6%2C7.6c4.1%2C4.1%2C10.8%2C4.1%2C15%2C0l118.8-118.8l118.8%2C118.8c4.1%2C4.1%2C10.8%2C4.1%2C15%2C0l7.6-7.6C291.1%2C125.5%2C291.1%2C118.9%2C287%2C114.7z%22%2F%3E%3C%2Fsvg%3E');
        }

        .lang-button.active {
            background-color: var(--border-main);
            color: var(--bg-container);
        }

        /* НОВЫЙ СТИЛЬ ДЛЯ ТЕКСТА ПРО ЧАСОВОЙ ПОЯС */
        .timezone-info {
            font-size: 0.9em;
            color: var(--draw-text);
            margin-top: 10px; /* Отступ сверху */
            margin-bottom: 30px; /* Отступ снизу перед первым блоком */
            text-align: center;
        }

        h2, h3 {
            text-transform: uppercase;
            letter-spacing: -0.5px;
            margin-top: 0; 
            margin-bottom: 20px; 
            color: var(--text-main);
            border-bottom: 2px solid var(--loss-border); 
            padding-bottom: 10px; 
        }
        .container > h2:first-of-type, .container > h3:first-of-type {
             margin-top: 0;
        }

        h4 { font-size: 1.2em; margin-bottom: 10px; color: var(--text-main); }

        /* --- ПОЛЯ И КНОПКИ --- */
        .input-section { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }

        input[type="text"], input[type="number"], input[type="date"] { 
            flex-grow: 1; padding: 15px; font-size: 1.1em; 
            border: 2px solid var(--input-border); 
            background: var(--input-bg);
            color: var(--text-main);
            font-weight: bold;
            transition: border-color 0.2s;
        }
        
        input:focus { outline: none; border-color: var(--border-main); }

        button { 
            padding: 15px 30px; font-size: 1.1em; font-weight: bold; text-transform: uppercase;
            cursor: pointer; 
            background-color: var(--btn-bg); 
            color: var(--btn-text); 
            border: 2px solid var(--border-main); 
            transition: all 0.2s; 
        }

        button:hover { 
            background-color: var(--btn-hover-bg); 
            color: var(--btn-hover-text); 
        }

        /* --- РЕЗУЛЬТАТЫ --- */
        #profile-result {
            font-size: 1.2em; margin-bottom: 20px;
            background: var(--item-hover);
            padding: 20px;
            border-left: 10px solid var(--border-main);
        }

        .daily-summary {
            background: var(--input-bg);
            border: 1px solid var(--loss-border);
            padding: 20px;
            margin-bottom: 20px;
        }
        .daily-summary h4 {
            margin-top: 0;
            border-bottom: 2px solid var(--border-main);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .daily-summary .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .daily-summary .stat-row .label {
            color: var(--draw-text);
        }
        .daily-summary .stat-row .value {
            color: var(--text-main);
        }
        .daily-summary .stat-row.total .value {
            font-size: 1.3em;
            color: var(--border-main);
        }
        .daily-summary .stat-row.win .value { color: var(--win-text); }
        .daily-summary .stat-row.loss .value { color: var(--loss-text); }
        .daily-summary .stat-row.draw .value { color: var(--draw-text); }
        .daily-summary .stat-row.speed {
            font-size: 1em;
            margin-left: 15px;
            font-weight: normal;
        }
        .daily-summary hr {
            border: none;
            border-top: 1px solid var(--loss-border);
            margin: 15px 0;
        }


        .game-list { list-style: none; padding: 0; margin-top: 20px; }
        
        .game-item { 
            display: flex; flex-wrap: wrap; /* Добавлено flex-wrap */
            justify-content: space-between; align-items: center; 
            padding: 15px 20px; border-bottom: 1px solid var(--loss-border); 
            font-size: 1em; color: var(--text-main);
        }
        
        .game-item:hover { background-color: var(--item-hover); }

        .win { border-left: 8px solid var(--win-border); }
        .loss { border-left: 8px solid var(--loss-border); }
        .draw { border-left: 8px solid var(--draw-border); }

        .game-info { color: var(--draw-text); flex-grow: 1; /* Чтобы занимал доступное место */ }
        .game-info strong { color: var(--text-main); font-size: 1.1em; }
        
        .game-result { font-weight: 900; text-transform: uppercase; margin-left: 20px; /* Отступ от инфо */ }
        .win .game-result { color: var(--win-text); }
        .loss .game-result { color: var(--loss-text); text-decoration: line-through; }
        .draw .game-result { color: var(--draw-text); }

        a { color: var(--text-main); text-decoration: underline; font-weight: bold; }
        a:hover { background-color: var(--border-main); color: var(--bg-container); text-decoration: none; }

        .loader { 
            border: 6px solid var(--bg-body); 
            border-top: 6px solid var(--border-main); 
            border-radius: 50%; width: 40px; height: 40px; 
            animation: spin 1s linear infinite; margin: 20px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { display: none; }
        
        /* FOOTER STYLES */
        footer {
            margin-top: 40px; /* Отступ сверху для футера */
            text-align: center;
            font-size: 0.8em; /* Небольшой размер шрифта */
            color: var(--draw-text); /* Цвет текста, чтобы не выделялся сильно */
        }
        footer p { /* Добавляем отступы между строками в футере */
            margin: 5px 0;
        }

        @media (max-width: 650px) {
            .header-row { flex-direction: column; align-items: flex-start; }
            .theme-lang-controls { flex-direction: column; width: 100%; gap: 10px; }
            .theme-lang-controls select, .theme-lang-controls button { width: 100%; min-width: unset; }
            .input-section { flex-direction: column; }
            button { width: 100%; }
            .game-item { flex-direction: column; align-items: flex-start; } /* В столбец на моб. */
            .game-result { margin-left: 0; margin-top: 10px; } /* Отступы на моб. */
        }
    </style>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106381516', 'ym');

    ym(106381516, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/106381516" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->


</head>
<body>
    <div class="container">
        <!-- HEADER ROW: Заголовок и Выбор темы в одной строке -->
        <div class="header-row">
            <h1 data-i18n="app_title">Lichess Time Machine</h1>
            <div class="theme-lang-controls">
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="monochrome">1. Monochrome (Original)</option>
                    <option value="dark-green">2. Terminal Green (Soft)</option>
                    <option value="midnight">3. Midnight Blue</option>
                    <option value="forest">4. Forest Green</option>
                    <option value="sepia">5. Sepia Paper</option>
                    <option value="cyberpunk">6. Cyberpunk Neon</option>
                    <option value="ocean">7. Ocean Breeze</option>
                    <option value="dracula">8. Dracula Dark</option>
                    <option value="crimson">9. Crimson Red</option>
                    <option value="solar-light">10. Solarized Light</option>
                    <option value="high-contrast">11. High Contrast</option>
                    <option value="royal">12. Royal Purple</option>
                </select>
                <button class="lang-button" data-lang="en" onclick="switchLanguage('en')">EN</button>
                <button class="lang-button" data-lang="ru" onclick="switchLanguage('ru')">RU</button>
            </div>
        </div>

        <!-- Текст про часовой пояс -->
        <p class="timezone-info" data-i18n="timezone_explanation_text"></p>
        
        <!-- БЛОК 1 -->
        <h2><strong>01.</strong> <span data-i18n="section_1_title">Player Profile Search</span></h2>
        <div class="input-section">
            <input type="text" id="username" data-i18n-placeholder="username_placeholder" placeholder="Username">
            <button onclick="fetchUserData()" data-i18n="search_button">Search</button>
        </div>
        <div id="main-loading" class="hidden"><div class="loader"></div></div>
        <div id="profile-result"></div>

        <!-- БЛОК 2 -->
        <div id="daily-section" class="hidden">
            <h2><strong>02.</strong> <span data-i18n="section_2_title">Games for a Day</span></h2>
            <div class="input-section">
                <input type="date" id="daily-date">
                <button onclick="fetchDailyGames()" data-i18n="show_games_button">Show Games</button>
            </div>
            <div id="daily-loading" class="hidden"><div class="loader"></div></div>
            <div id="daily-results"></div>
        </div>

        <!-- БЛОК 3 -->
        <div id="yearly-section" class="hidden">
            <h2><strong>03.</strong> <span data-i18n="section_3_title">Annual Summary</span></h2>
            <p class="warning-text" data-i18n="yearly_warning_long_load" style="font-size:0.9em; color:var(--loss-text); margin-top:5px; margin-bottom: 20px;"></p>
            <div class="input-section">
                <input type="number" id="year-input" data-i18n-placeholder="year_placeholder" placeholder="Year (2024)">
                <button onclick="fetchYearlyStats()" data-i18n="calculate_button">Calculate</button>
            </div>
            <div id="yearly-loading" class="hidden">
                <div class="loader"></div>
                <div id="progress-text" style="text-align: center; color: var(--draw-text); font-weight: bold;"></div>
            </div>
            <div id="yearly-results" style="padding: 20px; background: var(--input-bg); border: 1px solid var(--loss-border); margin-top: 20px;"></div>
        </div>
    </div>

    <footer>
        <p data-i18n="footer_credit_text"></p>
        <!-- НОВОЕ: Строка про использование API Lichess -->
        <p data-i18n="api_credit_text"></p>
    </footer>

    <script>
        // --- Translations object ---
        const translations = {
            en: {
                'app_title': 'Lichess Time Machine',
                'section_1_title': 'Player Profile Search',
                'username_placeholder': 'Username',
                'search_button': 'Search',
                'section_2_title': 'Games for a Day',
                'show_games_button': 'Show Games',
                'section_3_title': 'Annual Summary',
                'year_placeholder': 'Year (2024)',
                'calculate_button': 'Calculate',
                'alert_enter_username': 'Enter a username',
                'alert_select_date': 'Select a date',
                'error_player_not_found': 'Player not found',
                'error_search_first': 'Error: Please search for a player first.',
                'online_status': 'ONLINE',
                'offline_status': 'OFFLINE',
                'profile_bullet': 'BULLET',
                'profile_blitz': 'BLITZ',
                'profile_rapid': 'RAPID',
                'profile_classical': 'CLASSICAL',
                'profile_960': '960',
                'daily_summary_title': 'Summary for',
                'daily_total_games': 'Total Games:',
                'daily_wins': 'Wins:',
                'daily_losses': 'Losses:',
                'daily_draws': 'Draws:',
                'daily_ratings_title': 'Ratings for the day:',
                'daily_no_ratings': 'No rating data available for game types played this day.',
                'daily_start_rating': 'Start:',
                'daily_end_rating': 'End:',
                'daily_by_game_type': 'By Game Type:',
                'daily_games_label': 'games',
                'daily_win_label_full': 'Wins',
                'daily_loss_label_full': 'Losses',
                'daily_draw_label_full': 'Draws',
                'daily_win_short': 'W', 
                'daily_loss_short': 'L',
                'daily_draw_short': 'D',
                'daily_no_games_found': 'No games found for this date.',
                'daily_opponent_vs': 'vs',
                'daily_anonymous': 'Anonymous',
                'daily_rated': 'Rated',
                'daily_unrated': 'Unrated',
                'daily_review_button': 'REVIEW >',
                'game_result_win': 'WIN',
                'game_result_loss': 'LOSS',
                'game_result_draw': 'DRAW',
                'yearly_summary_title': 'SUMMARY FOR',
                'yearly_total_games': 'TOTAL GAMES:',
                'yearly_wins': 'WINS:',
                'yearly_losses': 'LOSSES:',
                'yearly_draws': 'DRAWS:',
                'loader_connecting': 'Connecting...',
                'loader_processed': 'Processed:',
                'error_fetching_daily': 'Error fetching daily games:',
                'error_fetching_yearly': 'Error fetching yearly games:',
                'yearly_warning_long_load': 'Note: If there are many games, loading annual statistics may take a long time and could temporarily freeze your browser.',
                'footer_credit_text': 'Site Authors: Stepan Aleksandrovich Mamakin (gumanitarij) and Gemini 2.5 Flash',
                'timezone_explanation_text': 'Rating calculations for a specific day are based on the user\'s local time zone, from 00:00 to 23:59.',
                'api_credit_text': 'Powered by Lichess API', // NEW
            },
            ru: {
                'app_title': 'Lichess Машина Времени',
                'section_1_title': 'Поиск профиля игрока',
                'username_placeholder': 'Имя пользователя',
                'search_button': 'Найти',
                'section_2_title': 'Игры за день',
                'show_games_button': 'Показать игры',
                'section_3_title': 'Ежегодная сводка',
                'year_placeholder': 'Год (2024)',
                'calculate_button': 'Рассчитать',
                'alert_enter_username': 'Введите имя пользователя',
                'alert_select_date': 'Выберите дату',
                'error_player_not_found': 'Игрок не найден',
                'error_search_first': 'Ошибка: Сначала найдите игрока.',
                'online_status': 'ОНЛАЙН',
                'offline_status': 'ОФФЛАЙН',
                'profile_bullet': 'ПУЛЯ',
                'profile_blitz': 'БЛИЦ',
                'profile_rapid': 'РАПИД',
                'profile_classical': 'КЛАССИКА',
                'profile_960': '960',
                'daily_summary_title': 'Сводка за',
                'daily_total_games': 'Всего игр:',
                'daily_wins': 'Победы:',
                'daily_losses': 'Поражения:',
                'daily_draws': 'Ничьи:',
                'daily_ratings_title': 'Рейтинги за день:',
                'daily_no_ratings': 'Нет данных о рейтингах для типов игр, сыгранных в этот день.',
                'daily_start_rating': 'Начало:',
                'daily_end_rating': 'Конец:',
                'daily_by_game_type': 'По типу игры:',
                'daily_games_label': 'игр',
                'daily_win_label_full': 'Победы',
                'daily_loss_label_full': 'Поражения',
                'daily_draw_label_full': 'Ничьи',
                'daily_win_short': 'П', 
                'daily_loss_short': 'ПОР',
                'daily_draw_short': 'Н',
                'daily_no_games_found': 'Игр за эту дату не найдено.',
                'daily_opponent_vs': 'против',
                'daily_anonymous': 'Аноним',
                'daily_rated': 'Рейтинговая',
                'daily_unrated': 'Нерейтинговая',
                'daily_review_button': 'ОБЗОР >',
                'game_result_win': 'ПОБЕДА',
                'game_result_loss': 'ПОРАЖЕНИЕ',
                'game_result_draw': 'НИЧЬЯ',
                'yearly_summary_title': 'СВОДКА ЗА',
                'yearly_total_games': 'ВСЕГО ИГР:',
                'yearly_wins': 'ПОБЕДЫ:',
                'yearly_losses': 'ПОРАЖЕНИЯ:',
                'yearly_draws': 'НИЧЬИ:',
                'loader_connecting': 'Подключение...',
                'loader_processed': 'Обработано:',
                'error_fetching_daily': 'Ошибка при получении игр за день:',
                'error_fetching_yearly': 'Ошибка при получении игр за год:',
                'yearly_warning_long_load': 'Внимание: Если партий очень много, загрузка годовой статистики может занять продолжительное время и может привести к временному зависанию браузера.',
                'footer_credit_text': 'Авторы сайта: Степан Александрович Мамакин (gumanitarij) и Gemini 2.5 Flash',
                'timezone_explanation_text': 'Расчет рейтингов за конкретный день происходит по местному времени для любого пользователя Земли, независимо от его местоположения с 00:00 до 23:59.',
                'api_credit_text': 'Работает на Lichess API', // NEW
            }
        };

        let currentLanguage = localStorage.getItem('lichess_lang') || 'en';
        
        function changeTheme(themeName) {
            if (themeName === 'monochrome') {
                document.body.removeAttribute('data-theme');
            } else {
                document.body.setAttribute('data-theme', themeName);
            }
            localStorage.setItem('lichess_theme', themeName);
        }

        function translatePage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage][key]) {
                    el.placeholder = translations[currentLanguage][key];
                }
            });

            document.title = translations[currentLanguage]['app_title'];

            document.querySelectorAll('.lang-button').forEach(button => {
                if (button.dataset.lang === currentLanguage) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('lichess_lang', lang);
            translatePage();
            if (currentLichessId) {
                fetchUserData(); 
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            try { 
                const savedTheme = localStorage.getItem('lichess_theme') || 'monochrome';
                document.getElementById('theme-select').value = savedTheme;
                changeTheme(savedTheme);

                const savedLang = localStorage.getItem('lichess_lang') || 'en';
                switchLanguage(savedLang); 
                
                document.getElementById('daily-date').valueAsDate = new Date();
                document.getElementById('year-input').value = new Date().getFullYear();
            } catch (e) {
                console.error("Error during DOMContentLoaded:", e);
            }
        });


        let currentLichessId = null;

        function formatPercentage(count, total) {
            if (total === 0) return '0%';
            return ((count / total) * 100).toFixed(1) + '%';
        }

        async function fetchUserData() {
            const rawUsername = document.getElementById('username').value.trim();
            if (!rawUsername) return alert(translations[currentLanguage]['alert_enter_username']);

            document.getElementById('main-loading').classList.remove('hidden');
            document.getElementById('profile-result').innerHTML = '';
            document.getElementById('daily-section').classList.add('hidden');
            document.getElementById('yearly-section').classList.add('hidden');

            try {
                const response = await fetch(`https://lichess.org/api/user/${rawUsername}`);
                if (!response.ok) throw new Error(translations[currentLanguage]['error_player_not_found']);
                const data = await response.json();
                
                currentLichessId = data.id; 
                
                const onlineText = data.online ? translations[currentLanguage]['online_status'] : translations[currentLanguage]['offline_status'];
                const onlineStyle = data.online ? 'color: var(--online-color)' : 'color: var(--offline-color)';
                
                document.getElementById('profile-result').innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:1.5em; font-weight:900;">${data.username}</span>
                        <span style="font-size:0.8em; border: 1px solid var(--border-main); padding: 5px 10px; ${onlineStyle}">${onlineText}</span>
                    </div>
                    <div style="margin-top:10px; font-size: 0.9em; line-height: 1.8;">
                        ${translations[currentLanguage]['profile_bullet']}: <strong>${data.perfs.bullet?.rating || '-'}</strong> &nbsp;|&nbsp;
                        ${translations[currentLanguage]['profile_blitz']}: <strong>${data.perfs.blitz?.rating || '-'}</strong> &nbsp;|&nbsp; 
                        ${translations[currentLanguage]['profile_rapid']}: <strong>${data.perfs.rapid?.rating || '-'}</strong> &nbsp;|&nbsp;
                        ${translations[currentLanguage]['profile_classical']}: <strong>${data.perfs.classical?.rating || '-'}</strong> &nbsp;|&nbsp;
                        ${data.perfs.chess960 ? `${translations[currentLanguage]['profile_960']}: <strong>${data.perfs.chess960.rating || '-'}</strong>` : ''}
                    </div>
                `;
                
                document.getElementById('daily-section').classList.remove('hidden');
                document.getElementById('yearly-section').classList.remove('hidden');

            } catch (e) {
                document.getElementById('profile-result').innerHTML = `<p style="color:var(--loss-text)">${translations[currentLanguage]['error_player_not_found']}: ${e.message}</p>`;
            } finally {
                document.getElementById('main-loading').classList.add('hidden');
            }
        }

        async function fetchDailyGames() {
            const dateInput = document.getElementById('daily-date').value;
            if (!dateInput) return alert(translations[currentLanguage]['alert_select_date']);
            
            if (!currentLichessId) {
                document.getElementById('daily-results').innerHTML = `<p style="color:var(--loss-text)">${translations[currentLanguage]['error_search_first']}</p>`;
                document.getElementById('daily-loading').classList.add('hidden');
                return;
            }

            const resultsDiv = document.getElementById('daily-results');
            resultsDiv.innerHTML = '';
            document.getElementById('daily-loading').classList.remove('hidden');

            const dateObj = new Date(dateInput);
            dateObj.setHours(0, 0, 0, 0);
            const since = dateObj.getTime();
            dateObj.setHours(23, 59, 59, 999);
            const until = dateObj.getTime();

            const url = `https://lichess.org/api/games/user/${currentLichessId}?since=${since}&until=${until}&moves=false&opening=true`;

            try {
                const response = await fetch(url, { headers: { 'Accept': 'application/x-ndjson' } });
                if (!response.ok) {
                    throw new Error(`${response.status} ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let games = [];

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    for (const line of lines) if (line) games.push(JSON.parse(line));
                }

                if (games.length === 0) {
                    resultsDiv.innerHTML = `<p style="padding:20px; color:var(--draw-text);">${translations[currentLanguage]['daily_no_games_found']}</p>`;
                } else {
                    let totalGames = games.length;
                    let totalWins = 0, totalLosses = 0, totalDraws = 0;
                    let speedStats = {}; 
                    let dailyStartRatings = {}; 
                    let dailyEndRatings = {};   

                    games.forEach(game => {
                        const amIWhite = (game.players.white.user?.id === currentLichessId);
                        const perfCategory = game.perf || 'Other';
                        
                        let playerRatingAfterGame;
                        if (game.rated) { 
                            const playerStats = amIWhite ? game.players.white : game.players.black;
                            if (playerStats && playerStats.rating !== undefined && playerStats.ratingDiff !== undefined) {
                                playerRatingAfterGame = playerStats.rating + playerStats.ratingDiff;
                            }
                        }
                        
                        if (playerRatingAfterGame !== undefined && dailyEndRatings[perfCategory] === undefined) {
                            dailyEndRatings[perfCategory] = playerRatingAfterGame;
                        }

                        if (!speedStats[perfCategory]) {
                            speedStats[perfCategory] = { total: 0, wins: 0, losses: 0, draws: 0 };
                        }
                        const currentPerfStats = speedStats[perfCategory];
                        currentPerfStats.total++;

                        if (game.winner) {
                            if ((game.winner === 'white' && amIWhite) || (game.winner === 'black' && !amIWhite)) {
                                totalWins++;
                                currentPerfStats.wins++; 
                            } else {
                                totalLosses++;
                                currentPerfStats.losses++; 
                            }
                        } else {
                            totalDraws++;
                            currentPerfStats.draws++; 
                        }
                    });

                    for (let i = games.length - 1; i >= 0; i--) {
                        const game = games[i];
                        const amIWhite = (game.players.white.user?.id === currentLichessId); 
                        const perfCategory = game.perf || 'Other';
                        
                        let playerRatingBeforeGame;
                        if (game.rated) {
                            const playerStats = amIWhite ? game.players.white : game.players.black;
                            if (playerStats && playerStats.rating !== undefined) {
                                playerRatingBeforeGame = playerStats.rating;
                            }
                        }
                        
                        if (playerRatingBeforeGame !== undefined && dailyStartRatings[perfCategory] === undefined) {
                            dailyStartRatings[perfCategory] = playerRatingBeforeGame;
                        }
                    }
                    
                    const totalWinPct = formatPercentage(totalWins, totalGames);
                    const totalLossPct = formatPercentage(totalLosses, totalGames);
                    const totalDrawPct = formatPercentage(totalDraws, totalGames);

                    let summaryHtml = `
                        <div class="daily-summary">
                            <h4>${translations[currentLanguage]['daily_summary_title']} ${dateInput}</h4>
                            <div class="stat-row total">
                                <span class="label">${translations[currentLanguage]['daily_total_games']}</span>
                                <span class="value">${totalGames}</span>
                            </div>
                            <div class="stat-row win">
                                <span class="label">${translations[currentLanguage]['daily_wins']}</span>
                                <span class="value">${totalWins} (${totalWinPct})</span>
                            </div>
                            <div class="stat-row loss">
                                <span class="label">${translations[currentLanguage]['daily_losses']}</span>
                                <span class="value">${totalLosses} (${totalLossPct})</span>
                            </div>
                            <div class="stat-row draw">
                                <span class="label">${translations[currentLanguage]['daily_draws']}</span>
                                <span class="value">${totalDraws} (${totalDrawPct})</span>
                            </div>
                            <hr>
                            <h4>${translations[currentLanguage]['daily_ratings_title']}</h4>
                    `;
                    const allPerfs = new Set([...Object.keys(dailyStartRatings), ...Object.keys(dailyEndRatings)]);

                    if (allPerfs.size === 0) {
                        summaryHtml += `<p style="font-size:0.9em; color:var(--draw-text);">${translations[currentLanguage]['daily_no_ratings']}</p>`;
                    } else {
                        allPerfs.forEach(perf => {
                            const startRating = dailyStartRatings[perf] !== undefined ? dailyStartRatings[perf] : '-';
                            const endRating = dailyEndRatings[perf] !== undefined ? dailyEndRatings[perf] : '-';
                            let ratingChange = '';
                            if (startRating !== '-' && endRating !== '-') {
                                const change = endRating - startRating;
                                ratingChange = ` (${change > 0 ? '+' : ''}${change})`;
                            }

                            summaryHtml += `
                                <div class="stat-row speed">
                                    <span class="label">${perf}:</span>
                                    <span class="value">${translations[currentLanguage]['daily_start_rating']} ${startRating} / ${translations[currentLanguage]['daily_end_rating']} ${endRating}${ratingChange}</span>
                                </div>
                            `;
                        });
                    }
                    summaryHtml += `<hr>`;
                    summaryHtml += `<h4>${translations[currentLanguage]['daily_by_game_type']}</h4>`;

                    for (const perf in speedStats) {
                        const stats = speedStats[perf];
                        const perfWinPct = formatPercentage(stats.wins, stats.total);
                        const perfLossPct = formatPercentage(stats.losses, stats.total);
                        const perfDrawPct = formatPercentage(stats.draws, stats.total);

                        summaryHtml += `
                            <div class="stat-row">
                                <span class="label">${perf}:</span>
                                <span class="value">
                                    ${stats.total} ${translations[currentLanguage]['daily_games_label']} 
                                    (${translations[currentLanguage]['daily_win_label_full']}:${stats.wins} ${perfWinPct} / 
                                    ${translations[currentLanguage]['daily_loss_label_full']}:${stats.losses} ${perfLossPct} / 
                                    ${translations[currentLanguage]['daily_draw_label_full']}:${stats.draws} ${perfDrawPct})
                                </span>
                            </div>
                        `;
                    }
                    summaryHtml += `</div>`;


                    let gamesListHtml = '<ul class="game-list">';
                    games.reverse().forEach(game => { 
                        const amIWhite = (game.players.white.user?.id === currentLichessId);
                        let resultClass = 'draw';
                        let resultText = translations[currentLanguage]['game_result_draw'];
                        
                        if (game.winner) {
                            if ((game.winner === 'white' && amIWhite) || (game.winner === 'black' && !amIWhite)) {
                                resultClass = 'win'; resultText = translations[currentLanguage]['game_result_win'];
                            } else {
                                resultClass = 'loss'; resultText = translations[currentLanguage]['game_result_loss'];
                            }
                        } else {
                            resultText = translations[currentLanguage]['game_result_draw'];
                        }

                        const opponent = amIWhite ? game.players.black.user?.name || translations[currentLanguage]['daily_anonymous'] : game.players.white.user?.name || translations[currentLanguage]['daily_anonymous'];
                        const opponentInitialRating = amIWhite ? game.players.black.rating : game.players.white.rating;
                        const opponentRatingText = opponentInitialRating ? `(${opponentInitialRating})` : '';

                        const time = new Date(game.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const gameUrl = `https://lichess.org/${game.id}`;

                        let gameTypeDisplay = game.perf;
                        if (game.speed && game.speed.toLowerCase() !== game.perf.toLowerCase()) {
                            gameTypeDisplay += ` • ${game.speed}`;
                        }

                        gamesListHtml += `
                            <li class="game-item ${resultClass}">
                                <div class="game-info">
                                    <strong>${time}</strong> ${translations[currentLanguage]['daily_opponent_vs']} ${opponent} ${opponentRatingText}
                                    <div style="font-size:0.8em; color:var(--draw-text); margin-top:5px;">
                                        ${gameTypeDisplay}
                                        ${game.rated ? ` • ${translations[currentLanguage]['daily_rated']}` : ` • ${translations[currentLanguage]['daily_unrated']}`}
                                        ${game.variant && game.variant !== 'standard' ? ` • ${game.variant}` : ''}
                                        ${game.opening?.name ? ` • ${game.opening.name}` : ''}
                                    </div>
                                </div>
                                <div class="game-result">
                                    ${resultText}
                                    <br><a href="${gameUrl}" target="_blank" style="font-size:0.7em; font-weight:normal;">${translations[currentLanguage]['daily_review_button']}</a>
                                </div>
                            </li>
                        `;
                    });
                    gamesListHtml += '</ul>';
                    
                    resultsDiv.innerHTML = summaryHtml + gamesListHtml;
                }

            } catch (e) {
                resultsDiv.innerHTML = `<p style="color:var(--loss-text)">${translations[currentLanguage]['error_fetching_daily']} ${e.message}</p>`;
            } finally {
                document.getElementById('daily-loading').classList.add('hidden');
            }
        }

        async function fetchYearlyStats() {
            const year = document.getElementById('year-input').value;
            const resultsDiv = document.getElementById('yearly-results');
            const progressText = document.getElementById('progress-text');
            
            resultsDiv.innerHTML = '';
            document.getElementById('yearly-loading').classList.remove('hidden');
            progressText.textContent = translations[currentLanguage]['loader_connecting'];

            if (!currentLichessId) {
                resultsDiv.innerHTML = `<p style="color:var(--loss-text)">${translations[currentLanguage]['error_search_first']}</p>`;
                document.getElementById('yearly-loading').classList.add('hidden');
                return;
            }

            const since = new Date(`${year}-01-01`).getTime();
            const until = new Date(`${year}-12-31T23:59:59.999`).getTime(); 
            const url = `https://lichess.org/api/games/user/${currentLichessId}?since=${since}&until=${until}&moves=false&opening=true`;

            let wins = 0, losses = 0, draws = 0, total = 0;

            try {
                const response = await fetch(url, { headers: { 'Accept': 'application/x-ndjson' } });
                if (!response.ok) {
                    throw new Error(`${response.status} ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line) continue;
                        try {
                            const game = JSON.parse(line);
                            total++;
                            if (total % 100 === 0) progressText.textContent = `${translations[currentLanguage]['loader_processed']} ${total}`;

                            const amIWhite = (game.players.white.user?.id === currentLichessId);
                            if (!game.winner) draws++;
                            else if ((game.winner === 'white' && amIWhite) || (game.winner === 'black' && !amIWhite)) wins++;
                            else losses++;
                        } catch(e){
                            console.warn("Skipping malformed game line:", e);
                        }
                    }
                }
                
                const yearlyWinPct = formatPercentage(wins, total);
                const yearlyLossPct = formatPercentage(losses, total);
                const yearlyDrawPct = formatPercentage(draws, total);

                resultsDiv.innerHTML = `
                    <h4 style="margin-top:0;">${translations[currentLanguage]['yearly_summary_title']} ${year}</h4>
                    <p style="font-size: 1.5em; font-weight:900;">${translations[currentLanguage]['yearly_total_games']} ${total}</p>
                    <hr style="border:0; border-top:1px solid var(--loss-border); margin: 20px 0;">
                    <div style="display:flex; justify-content:space-between;">
                        <div>${translations[currentLanguage]['yearly_wins']} <strong>${wins} (${yearlyWinPct})</strong></div>
                        <div>${translations[currentLanguage]['yearly_losses']} <strong style="color:var(--draw-text); text-decoration:line-through;">${losses} (${yearlyLossPct})</strong></div>
                        <div>${translations[currentLanguage]['yearly_draws']} <span style="color:var(--draw-text);">${draws} (${yearlyDrawPct})</span></div>
                    </div>
                `;

            } catch (e) {
                resultsDiv.innerHTML = `<p style="color:var(--loss-text)">${translations[currentLanguage]['error_fetching_yearly']} ${e.message}</p>`;
            } finally {
                document.getElementById('yearly-loading').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
